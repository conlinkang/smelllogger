<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>臭味標記地圖</title>
  <style>
    #map {
      height: 500px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h3>標記臭味位置</h3>
  <form id="smellForm">
    <div class="options">
      <label>臭味程度:</label>
      <label><input type="radio" name="smellLevel" value="1" required> 1</label>
      <label><input type="radio" name="smellLevel" value="2" required> 2</label>
      <label><input type="radio" name="smellLevel" value="3" required> 3</label>
      <label><input type="radio" name="smellLevel" value="4" required> 4</label>
      <label><input type="radio" name="smellLevel" value="5" required> 5</label>
    </div>
    <br>
    <label for="smellTime">聞到的時間:</label>
    <input id="smellTime" type="datetime-local" name="smellTime" required>
    <br>
    <button type="submit">提交</button>
  </form>
  <div id="weatherInfo">
    <p class="weather-description"></p>
    <p class="temperature"></p>
    <p class="wind-speed"></p>
    <p class="wind-direction"></p>
  </div>
  <div id="map"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDanmWlmu2ecmlLrHzoBtX_lGlJjr8rIWI&callback=initMap" async defer></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      setDefaultTime();
      document.getElementById('smellForm').addEventListener('submit', handleFormSubmit);
    });

    function setDefaultTime() {
      const dateInput = document.getElementById('smellTime');
      const now = new Date();
      const localISOTime = new Date(now - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
      dateInput.value = localISOTime;
    }

    let map, marker, currentPosition;

    function initMap() { 
      const center = {lat: 23.713179185745247, lng: 120.50557988120599}; // 中心坐標
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 15,
        center: center
      });

      const kmInLatitudeDegree = 1 / 110.574; // 每公里的緯度度數
      const kmInLongitudeDegree = 1 / (111.320 * Math.cos(center.lat * Math.PI / 180)); // 每公里的經度度數

      // 生成15x15的500m網格
      const gridSize = 0.25; // 每格500m

      for (let i = -7; i <= 7; i++) {
        for (let j = -7; j <= 7; j++) {
          const gridBounds = {
            north: center.lat + (i + 1) * gridSize * kmInLatitudeDegree,
            south: center.lat + i * gridSize * kmInLatitudeDegree,
            east: center.lng + (j + 1) * gridSize * kmInLongitudeDegree,
            west: center.lng + j * gridSize * kmInLongitudeDegree,
          };

          const grid = new google.maps.Rectangle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.1,
            map: map,
            bounds: gridBounds,
          });

          // 每个网格添加点击事件
          grid.addListener('click', function() {
            const centerLat = (gridBounds.north + gridBounds.south) / 2;
            const centerLng = (gridBounds.east + gridBounds.west) / 2;
            alert('已選擇網格的中心： [' + centerLat.toFixed(4) + ', ' + centerLng.toFixed(4) + ']');
            placeMarkerAndPanTo({lat: centerLat, lng: centerLng});
            getWeather(centerLat, centerLng);
          });
        }
      }
    }

    function placeMarkerAndPanTo(latLng) {
      if (marker) {
        marker.setPosition(latLng);
      } else {
        marker = new google.maps.Marker({
          position: latLng,
          map: map
        });
      }
      map.panTo(latLng);
      currentPosition = latLng;
    }

    function getWeather(lat, lon) {
      const apiKey = 'b142facd0784f0961a51dc355befed53';
      const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          const weather = data.weather[0].description;
          const temperature = data.main.temp;
          const windSpeed = data.wind.speed;
          const windDirection = data.wind.deg;
          const weatherInfo = document.getElementById('weatherInfo');
          weatherInfo.querySelector('.weather-description').innerText = `氣象狀態: ${weather}`;
          weatherInfo.querySelector('.temperature').innerText = `溫度: ${temperature}°C`;
          weatherInfo.querySelector('.wind-speed').innerText = `風速: ${windSpeed} m/s`;
          weatherInfo.querySelector('.wind-direction').innerText = `風向: ${windDirection}°`;
        })
        .catch(error => {
          console.error('Error fetching the weather data: ', error);
        });
    }

    function handleFormSubmit(event) {
      event.preventDefault();

      const smellLevel = document.getElementById('smellLevel').value;
      const smellTime = document.getElementById('smellTime').value;

      const weatherInfoDiv = document.getElementById('weatherInfo');
      const weatherInfo = {
        weather: weatherInfoDiv.querySelector('.weather-description').innerText,
        temperature: parseFloat(weatherInfoDiv.querySelector('.temperature').innerText.split(' ')[1]),
        windSpeed: parseFloat(weatherInfoDiv.querySelector('.wind-speed').innerText.split(' ')[1]),
        windDirection: parseInt(weatherInfoDiv.querySelector('.wind-direction').innerText.split(' ')[1])
      };

      if (currentPosition) {
        const data = {
          lat: currentPosition.lat,
          lng: currentPosition.lng,
          smellLevel: parseInt(smellLevel),
          smellTime: smellTime,
          weatherInfo: weatherInfo
        };
        console.log('数据提交:', JSON.stringify(data));
        fetch('https://script.google.com/macros/s/AKfycbyUj99gn97GCByUIjz03UcoXneInePsnctyv_Wpr0qTOWDk1Ms-x6Qy0wDKpXG8LiRX/exec', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
          mode: 'no-cors'
        })
        .then(() => {
          alert('臭味数据和气象信息已成功提交！');
        })
        .catch(() => {
          alert('提交出错，请检查网络或服务器设置');
        });
      } else {
        alert('请先在地图上点击选择一个位置!');
      }
    }
  </script>
</body>
</html>
